<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANS Registry - Administration</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #1f2937;
            background: #f9fafb;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .tabs {
            display: flex;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            overflow: hidden;
        }
        
        .tab {
            flex: 1;
            padding: 1rem 2rem;
            background: #f3f4f6;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: #667eea;
            color: white;
        }
        
        .tab:hover:not(.active) {
            background: #e5e7eb;
        }
        
        .tab-content {
            display: none;
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #374151;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-group small {
            display: block;
            margin-top: 0.25rem;
            color: #6b7280;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 0.5rem;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: #e5e7eb;
            color: #374151;
        }
        
        .btn-secondary:hover {
            background: #d1d5db;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .agent-list {
            margin-top: 2rem;
        }
        
        .agent-section {
            margin-bottom: 3rem;
        }
        
        .agent-section h4 {
            margin-bottom: 1rem;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-weight: 600;
        }
        
        .agent-section.public h4 {
            background: #dbeafe;
            color: #1e40af;
            border-left: 4px solid #3b82f6;
        }
        
        .agent-section.internal h4 {
            background: #f3e8ff;
            color: #7c2d12;
            border-left: 4px solid #a855f7;
        }
        
        .agent-section.private h4 {
            background: #fef3c7;
            color: #92400e;
            border-left: 4px solid #f59e0b;
        }
        
        .agent-item {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .agent-item .agent-info h5 {
            margin: 0 0 0.25rem 0;
            color: #1f2937;
            font-family: 'Monaco', monospace;
            font-size: 0.95rem;
        }
        
        .agent-item .agent-info p {
            margin: 0;
            color: #6b7280;
            font-size: 0.9rem;
        }
        
        .discovery-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }
        
        .discovery-badge.public {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .discovery-badge.internal {
            background: #f3e8ff;
            color: #7c2d12;
        }
        
        .discovery-badge.private {
            background: #fef3c7;
            color: #92400e;
        }
        
        .capabilities {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 0.5rem;
        }
        
        .capability {
            background: #e0e7ff;
            color: #3730a3;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 0.5rem;
        }
        
        .status-active {
            background: #10b981;
        }
        
        .status-inactive {
            background: #ef4444;
        }
        
        .status-maintenance {
            background: #f59e0b;
        }
        
        .code-preview {
            background: #1f2937;
            color: #f9fafb;
            padding: 1rem;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9rem;
            overflow-x: auto;
            margin-top: 1rem;
        }
        
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border-left: 4px solid #3b82f6;
        }
        
        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
        }
        
        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #ef4444;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .card h3 {
            margin-bottom: 1rem;
            color: #1f2937;
        }
        
        .loading {
            display: none;
            text-align: center;
            color: #667eea;
            margin: 1rem 0;
        }
        
        .test-result {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid #10b981;
            background: #f0f9ff;
        }
        
        .test-result.error {
            border-left-color: #ef4444;
            background: #fef2f2;
        }
        
        .discovery-info {
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid;
            margin-top: 1rem;
            display: none;
        }
        
        .discovery-info.public {
            background: #dbeafe;
            border-left-color: #3b82f6;
            color: #1e40af;
        }
        
        .discovery-info.internal {
            background: #f3e8ff;
            border-left-color: #a855f7;
            color: #7c2d12;
        }
        
        .discovery-info.private {
            background: #fef3c7;
            border-left-color: #f59e0b;
            color: #92400e;
        }
        
        .stats-bar {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .stat-item {
            text-align: center;
            flex: 1;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #6b7280;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        /* Developer API Interface Styles */
        #discovery .card {
            background: #1e293b !important;
            border: 1px solid #334155 !important;
        }
        
        #discovery .card h3 {
            color: #f1f5f9 !important;
            border-bottom: 2px solid #3b82f6 !important;
            padding-bottom: 0.5rem;
        }
        
        #discovery input,
        #discovery select {
            background: #1e293b !important;
            border: 1px solid #475569 !important;
            color: #e2e8f0 !important;
            font-family: Monaco, monospace !important;
        }
        
        #discovery input:focus,
        #discovery select:focus {
            border-color: #3b82f6 !important;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
        }
        
        #discovery .quick-test-card:hover {
            border-color: #3b82f6 !important;
            background: #475569 !important;
        }
        
        #discovery .btn-primary {
            background: #3b82f6 !important;
        }
        
        #discovery .btn-primary:hover {
            background: #2563eb !important;
        }
        
        #discovery .btn-secondary {
            background: #475569 !important;
            color: #e2e8f0 !important;
        }
        
        #discovery .btn-secondary:hover {
            background: #64748b !important;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ü§ñ ANS Registry</h1>
        <p>Agent Configuration & Management</p>
    </div>
    
    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="showTab('agents')">Agents</button>
            <button class="tab" onclick="showTab('discovery')">üîç Discovery API</button>
            <button class="tab" onclick="showTab('wellknown')">Well-Known Generation</button>
            <button class="tab" onclick="showTab('registry')">Registry Connection</button>
            <button class="tab" onclick="showTab('testing')">Testing</button>
        </div>
        
        <!-- Agents Tab -->
        <div id="agents" class="tab-content active">
            <h2>ü§ñ Agent Management</h2>
            <div class="alert alert-info">
                <strong>Agent Registry:</strong> Configure your agents and choose their discovery level. Agents are saved to JSON files for persistence.
            </div>
            
            <!-- Agent Statistics -->
            <div class="stats-bar">
                <div class="stat-item">
                    <div class="stat-number" id="publicCount">0</div>
                    <div class="stat-label">üåê Public</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="internalCount">0</div>
                    <div class="stat-label">üè¢ Internal</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="privateCount">0</div>
                    <div class="stat-label">üîí Private</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="totalCount">0</div>
                    <div class="stat-label">üìä Total</div>
                </div>
            </div>
            
            <form id="addAgentForm">
                <div class="grid">
                    <div class="form-group">
                        <label for="agentUri">Agent URI</label>
                        <input type="text" id="agentUri" placeholder="agent://support.company.com" required>
                        <small>Format: agent://[name].[service].[domain]</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="endpoint">Endpoint URL</label>
                        <input type="url" id="endpoint" placeholder="https://api.company.com/agents/support" required>
                        <small>The actual HTTP endpoint for this agent</small>
                    </div>
                </div>
                
                <div class="grid">
                    <div class="form-group">
                        <label for="discoveryLevel">üîç Discovery Level</label>
                        <select id="discoveryLevel" required>
                            <option value="public">üåê Public - Discoverable via .well-known (anyone can find)</option>
                            <option value="internal">üè¢ Internal - Your organization only</option>
                            <option value="private">üîí Private - No automatic discovery (manual config only)</option>
                        </select>
                        <small id="discoveryHelp">How should other systems discover this agent?</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="status">Status</label>
                        <select id="status">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="maintenance">Maintenance</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="capabilities">Capabilities</label>
                    <input type="text" id="capabilities" placeholder="support, billing, api">
                    <small>Comma-separated list of what this agent can do</small>
                </div>
                
                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea id="description" rows="3" placeholder="Customer support agent for billing inquiries"></textarea>
                </div>
                
                <!-- Discovery Level Info -->
                <div id="discoveryInfo" class="discovery-info">
                    <div id="publicInfo">
                        <strong>üåê Public Discovery:</strong><br>
                        ‚Ä¢ Agent will be included in .well-known/agent.json<br>
                        ‚Ä¢ Anyone on the internet can discover this agent<br>
                        ‚Ä¢ Good for: customer support, public APIs, developer tools
                    </div>
                    
                    <div id="internalInfo">
                        <strong>üè¢ Internal Discovery:</strong><br>
                        ‚Ä¢ Agent discoverable only within your organization<br>
                        ‚Ä¢ Not included in public .well-known file<br>
                        ‚Ä¢ Good for: HR, finance, internal tools, employee services
                    </div>
                    
                    <div id="privateInfo">
                        <strong>üîí Private:</strong><br>
                        ‚Ä¢ No automatic discovery - completely private<br>
                        ‚Ä¢ Must be configured manually by teams that need it<br>
                        ‚Ä¢ Good for: sensitive systems, admin tools, testing agents
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary">‚ûï Add Agent</button>
                <button type="button" class="btn btn-secondary" onclick="clearForm()">üóëÔ∏è Clear Form</button>
            </form>
            
            <div class="agent-list">
                <h3>Configured Agents</h3>
                <div id="agentsList">
                    <!-- Agents will be populated here -->
                </div>
            </div>
        </div>
        
        <!-- Well-Known Generation Tab -->
        <div id="wellknown" class="tab-content">
            <h2>üåê Well-Known Generation</h2>
            <div class="alert alert-info">
                <strong>Well-Known Discovery</strong> automatically generates <code>.well-known/agent.json</code> from your public agents.
            </div>
            
            <form id="wellKnownForm">
                <div class="form-group">
                    <label for="domain">Your Domain</label>
                    <input type="text" id="domain" placeholder="company.com" required>
                    <small>The domain where your .well-known file will be hosted</small>
                </div>
                
                <button type="button" class="btn btn-primary" onclick="generateWellKnown()">üîß Generate .well-known/agent.json</button>
                <button type="button" class="btn btn-success" onclick="validateWellKnown()">‚úÖ Test Well-Known URL</button>
                <button type="button" class="btn btn-secondary" onclick="downloadWellKnown()">üíæ Download File</button>
            </form>
            
            <div class="code-preview" id="wellKnownPreview" style="display: none;">
                <div>üìÑ Your .well-known/agent.json file:</div>
                <pre id="wellKnownCode"></pre>
            </div>
            
            <div class="alert alert-info" style="margin-top: 1rem;">
                <strong>Deployment Instructions:</strong><br>
                1. Generate the JSON above<br>
                2. Save as <code>.well-known/agent.json</code> in your website root<br>
                3. Ensure it's accessible at <code>https://yourdomain.com/.well-known/agent.json</code><br>
                4. Test the URL to verify it works
            </div>
        </div>
        
        <!-- Registry Connection Tab -->
        <div id="registry" class="tab-content">
            <h2>üåç ANS Registry Connection</h2>
            <div class="alert alert-info">
                <strong>Registry Connection</strong> allows your agents to be discoverable via the global ANS Registry network
            </div>
            
            <div id="connectionStatus" class="alert alert-info">
                <strong>Status:</strong> <span id="statusText">Not connected</span>
            </div>
            
            <form id="registryForm">
                <div class="form-group">
                    <label for="registryUrl">Registry URL</label>
                    <input type="url" id="registryUrl" value="https://registry.ansregistry.org" readonly>
                    <small>Official ANS Registry endpoint</small>
                </div>
                
                <div class="grid">
                    <div class="form-group">
                        <label for="apiKey">API Key</label>
                        <input type="password" id="apiKey" placeholder="ans_key_1234567890abcdef">
                        <small><a href="https://ansregistry.org/dashboard" target="_blank">Get your API key</a></small>
                    </div>
                    
                    <div class="form-group">
                        <label for="organizationId">Organization ID</label>
                        <input type="text" id="organizationId" placeholder="company-corp">
                        <small>Your unique organization identifier</small>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="enableSync"> 
                        Enable automatic synchronization with ANS Registry
                    </label>
                    <small>Automatically sync your agents with the global registry</small>
                </div>
                
                <button type="button" class="btn btn-primary" onclick="testConnection()">üîó Test Connection</button>
                <button type="button" class="btn btn-success" onclick="syncAgents()">üîÑ Sync Agents</button>
            </form>
            
            <div class="card" style="margin-top: 2rem;">
                <h3>üéØ Benefits of Registry Connection</h3>
                <ul style="margin-left: 1.5rem; color: #6b7280;">
                    <li>Global agent discovery across organizations</li>
                    <li>Automatic agent health monitoring</li>
                    <li>Analytics and usage insights</li>
                    <li>Cross-organization agent networking</li>
                    <li>Backup and disaster recovery</li>
                </ul>
            </div>
        </div>
        
        <!-- Testing Tab -->
        <div id="testing" class="tab-content">
            <h2>üß™ Agent Testing & Validation</h2>
            
            <div class="card">
                <h3>Test Agent Resolution</h3>
                <div class="form-group">
                    <label for="testUri">Agent URI to Test</label>
                    <input type="text" id="testUri" placeholder="agent://support.company.com">
                </div>
                
                <button class="btn btn-primary" onclick="testAgentResolution()">üöÄ Test Resolution</button>
                <button class="btn btn-secondary" onclick="validateUri()">‚úÖ Validate URI Format</button>
                
                <div class="loading" id="testLoading">
                    üîÑ Testing agent resolution...
                </div>
                
                <div id="testResults"></div>
            </div>
            
            <div class="card">
                <h3>Quick Test Examples</h3>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <button class="btn btn-secondary" onclick="setTestUri('agent://hello.dev.pbolduc')">Demo Hello</button>
                    <button class="btn btn-secondary" onclick="setTestUri('agent://support.demo.ansregistry')">Demo Support</button>
                    <button class="btn btn-secondary" onclick="setTestUri('agent://test.local')">Test Local</button>
                </div>
            </div>
        </div>
        
        <!-- Discovery API Test Interface -->
        <div id="discovery" class="tab-content">
            <h2 style="color: #f1f5f9; font-family: Monaco, monospace;">üîç Discovery API - Test Interface</h2>
            <div class="alert alert-info" style="background: #1e293b; border-left: 4px solid #3b82f6; color: #cbd5e1;">
                <strong>API Backend pour le Gateway:</strong> Interface de test pour d√©veloppeurs - Discovery Engine que le Gateway utilise pour trouver les bons agents.
            </div>
            
            <!-- Quick Test Scenarios for Gateway -->
            <div class="card" style="background: #1e293b; border: 1px solid #334155;">
                <h3 style="color: #f1f5f9; border-bottom: 2px solid #3b82f6; padding-bottom: 0.5rem;">‚ö° Tests rapides (sc√©narios Gateway)</h3>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-top: 1.5rem;">
                    <div class="quick-test-card" onclick="quickGatewayTest('billing')" style="background: #334155; border: 1px solid #475569; border-radius: 8px; padding: 1rem; cursor: pointer; text-align: center; transition: all 0.3s;">
                        <h4 style="margin-bottom: 0.5rem; color: #f1f5f9;">üí≥ Besoin Billing</h4>
                        <p style="font-size: 0.9rem; color: #94a3b8;">Gateway cherche agents pour traiter un paiement</p>
                    </div>
                    
                    <div class="quick-test-card" onclick="quickGatewayTest('support')" style="background: #334155; border: 1px solid #475569; border-radius: 8px; padding: 1rem; cursor: pointer; text-align: center; transition: all 0.3s;">
                        <h4 style="margin-bottom: 0.5rem; color: #f1f5f9;">üéß Besoin Support</h4>
                        <p style="font-size: 0.9rem; color: #94a3b8;">Agents support client disponibles</p>
                    </div>
                    
                    <div class="quick-test-card" onclick="quickGatewayTest('healthy')" style="background: #334155; border: 1px solid #475569; border-radius: 8px; padding: 1rem; cursor: pointer; text-align: center; transition: all 0.3s;">
                        <h4 style="margin-bottom: 0.5rem; color: #f1f5f9;">üíö Prod-Ready Only</h4>
                        <p style="font-size: 0.9rem; color: #94a3b8;">Filtre par sant√© pour production</p>
                    </div>
                    
                    <div class="quick-test-card" onclick="quickGatewayTest('fallback')" style="background: #334155; border: 1px solid #475569; border-radius: 8px; padding: 1rem; cursor: pointer; text-align: center; transition: all 0.3s;">
                        <h4 style="margin-bottom: 0.5rem; color: #f1f5f9;">üîÑ Fallback Strategy</h4>
                        <p style="font-size: 0.9rem; color: #94a3b8;">Alternatives si agent principal fail</p>
                    </div>
                </div>
            </div>
            
            <!-- Main Discovery API Interface -->
            <div class="card" style="background: #1e293b; border: 1px solid #334155;">
                <div style="background: #334155; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem; border-left: 4px solid #3b82f6;">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                        <span style="padding: 0.25rem 0.75rem; border-radius: 4px; font-weight: 600; font-size: 0.8rem; font-family: Monaco, monospace; background: #059669; color: white;">POST</span>
                        <span style="font-family: Monaco, monospace; font-size: 1.1rem; color: #60a5fa;">/api/discover</span>
                    </div>
                    <p style="color: #94a3b8; margin-bottom: 1rem;">
                        API principale pour le Gateway - trouve les meilleurs agents selon les crit√®res
                    </p>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                        <!-- Query Parameters -->
                        <div style="background: #334155; padding: 1.5rem; border-radius: 8px;">
                            <h4 style="margin-bottom: 1rem; color: #f1f5f9;">üéØ Crit√®res de recherche</h4>
                            
                            <div class="form-group">
                                <label style="color: #cbd5e1; font-size: 0.9rem;">Capabilities requises</label>
                                <input type="text" id="devCapabilities" placeholder="billing,payment" style="width: 100%; padding: 0.75rem; border: 1px solid #475569; border-radius: 6px; background: #1e293b; color: #e2e8f0; font-family: Monaco, monospace; font-size: 0.9rem;">
                                <small style="color: #94a3b8;">S√©par√©es par virgules</small>
                            </div>
                            
                            <div class="form-group">
                                <label style="color: #cbd5e1; font-size: 0.9rem;">Statut requis</label>
                                <select id="devStatus" multiple style="width: 100%; padding: 0.75rem; border: 1px solid #475569; border-radius: 6px; background: #1e293b; color: #e2e8f0; font-family: Monaco, monospace;">
                                    <option value="active" selected>Active</option>
                                    <option value="maintenance">Maintenance</option>
                                    <option value="inactive">Inactive</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label style="color: #cbd5e1; font-size: 0.9rem;">Sant√© requise</label>
                                <select id="devHealthStatus" multiple style="width: 100%; padding: 0.75rem; border: 1px solid #475569; border-radius: 6px; background: #1e293b; color: #e2e8f0; font-family: Monaco, monospace;">
                                    <option value="healthy" selected>Healthy</option>
                                    <option value="degraded">Degraded</option>
                                    <option value="unhealthy">Unhealthy</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label style="color: #cbd5e1; font-size: 0.9rem;">Score sant√© minimum</label>
                                <input type="number" id="devMinHealthScore" value="70" min="0" max="100" style="width: 100%; padding: 0.75rem; border: 1px solid #475569; border-radius: 6px; background: #1e293b; color: #e2e8f0; font-family: Monaco, monospace;">
                            </div>
                            
                            <div class="form-group">
                                <label style="color: #cbd5e1; font-size: 0.9rem;">Limite r√©sultats</label>
                                <input type="number" id="devLimit" value="10" min="1" max="100" style="width: 100%; padding: 0.75rem; border: 1px solid #475569; border-radius: 6px; background: #1e293b; color: #e2e8f0; font-family: Monaco, monospace;">
                            </div>
                        </div>
                        
                        <!-- Discovery Sources -->
                        <div style="background: #334155; padding: 1.5rem; border-radius: 8px;">
                            <h4 style="margin-bottom: 1rem; color: #f1f5f9;">üì° Sources de d√©couverte</h4>
                            
                            <div style="display: flex; flex-direction: column; gap: 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="devIncludeLocal" checked>
                                    <label for="devIncludeLocal" style="color: #cbd5e1;">üìÅ Local Storage</label>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="devIncludeWellKnown" checked>
                                    <label for="devIncludeWellKnown" style="color: #cbd5e1;">üåê Well-Known</label>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="devIncludeGlobal">
                                    <label for="devIncludeGlobal" style="color: #cbd5e1;">üåç Global Registry</label>
                                </div>
                            </div>
                            
                            <div class="form-group" style="margin-top: 1rem;">
                                <label style="color: #cbd5e1; font-size: 0.9rem;">Organisation sp√©cifique</label>
                                <input type="text" id="devOrganization" placeholder="stripe.com" style="width: 100%; padding: 0.75rem; border: 1px solid #475569; border-radius: 6px; background: #1e293b; color: #e2e8f0; font-family: Monaco, monospace;">
                            </div>
                            
                            <div class="form-group">
                                <label style="color: #cbd5e1; font-size: 0.9rem;">Discovery Level</label>
                                <select id="devDiscoveryLevel" multiple style="width: 100%; padding: 0.75rem; border: 1px solid #475569; border-radius: 6px; background: #1e293b; color: #e2e8f0; font-family: Monaco, monospace;">
                                    <option value="public" selected>Public</option>
                                    <option value="internal" selected>Internal</option>
                                    <option value="private" selected>Private</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1rem;">
                        <button class="btn btn-primary" onclick="testDiscoveryAPI()" style="background: #3b82f6; margin-right: 0.5rem;">üöÄ Test Discovery</button>
                        <button class="btn btn-secondary" onclick="generateDiscoveryCurl()" style="background: #475569;">üìã G√©n√©rer cURL</button>
                        <button class="btn btn-secondary" onclick="clearDevForm()" style="background: #475569;">üóëÔ∏è Reset</button>
                    </div>
                </div>
            </div>
            
            <!-- Additional APIs -->
            <div class="card" style="background: #1e293b; border: 1px solid #334155;">
                <h3 style="color: #f1f5f9; border-bottom: 2px solid #3b82f6; padding-bottom: 0.5rem;">üîß APIs compl√©mentaires</h3>
                
                <div style="background: #334155; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                        <span style="padding: 0.25rem 0.75rem; border-radius: 4px; font-weight: 600; font-size: 0.8rem; font-family: Monaco, monospace; background: #0ea5e9; color: white;">GET</span>
                        <span style="font-family: Monaco, monospace; color: #60a5fa;">/api/search/{query}</span>
                    </div>
                    <p style="color: #94a3b8; margin-bottom: 1rem;">Recherche textuelle simple dans tous les agents</p>
                    <div>
                        <input type="text" id="devSearchQuery" placeholder="billing stripe" style="width: 300px; margin-right: 1rem; padding: 0.5rem; border: 1px solid #475569; border-radius: 4px; background: #1e293b; color: #e2e8f0; font-family: Monaco, monospace;">
                        <button class="btn btn-primary" onclick="testSearchAPI()" style="background: #3b82f6;">üîç Test Search</button>
                    </div>
                </div>
                
                <div style="background: #334155; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                        <span style="padding: 0.25rem 0.75rem; border-radius: 4px; font-weight: 600; font-size: 0.8rem; font-family: Monaco, monospace; background: #0ea5e9; color: white;">GET</span>
                        <span style="font-family: Monaco, monospace; color: #60a5fa;">/api/healthy</span>
                    </div>
                    <p style="color: #94a3b8; margin-bottom: 1rem;">Agents en bonne sant√© seulement (pour production)</p>
                    <button class="btn btn-primary" onclick="testHealthyAPI()" style="background: #3b82f6;">üíö Test Healthy</button>
                </div>
                
                <div style="background: #334155; border-radius: 8px; padding: 1rem;">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                        <span style="padding: 0.25rem 0.75rem; border-radius: 4px; font-weight: 600; font-size: 0.8rem; font-family: Monaco, monospace; background: #0ea5e9; color: white;">GET</span>
                        <span style="font-family: Monaco, monospace; color: #60a5fa;">/api/capabilities/{caps}</span>
                    </div>
                    <p style="color: #94a3b8; margin-bottom: 1rem;">Trouve agents par capabilities sp√©cifiques</p>
                    <div>
                        <input type="text" id="devCapabilitiesQuery" placeholder="pay,billing" style="width: 300px; margin-right: 1rem; padding: 0.5rem; border: 1px solid #475569; border-radius: 4px; background: #1e293b; color: #e2e8f0; font-family: Monaco, monospace;">
                        <button class="btn btn-primary" onclick="testCapabilitiesAPI()" style="background: #3b82f6;">üéØ Test Capabilities</button>
                    </div>
                </div>
            </div>
            
            <!-- Response Section -->
            <div class="card" style="background: #1e293b; border: 1px solid #334155;">
                <h3 style="color: #f1f5f9; border-bottom: 2px solid #3b82f6; padding-bottom: 0.5rem;">üìä R√©ponse API</h3>
                
                <div id="devResponseMetrics" style="display: none; margin-bottom: 1rem;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem;">
                        <div style="text-align: center; padding: 1rem; background: #334155; border-radius: 6px; border: 1px solid #475569;">
                            <div id="devAgentsFound" style="font-size: 1.5rem; font-weight: bold; color: #3b82f6;">-</div>
                            <div style="font-size: 0.8rem; color: #94a3b8;">Agents trouv√©s</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: #334155; border-radius: 6px; border: 1px solid #475569;">
                            <div id="devQueryTime" style="font-size: 1.5rem; font-weight: bold; color: #3b82f6;">-</div>
                            <div style="font-size: 0.8rem; color: #94a3b8;">Temps requ√™te</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: #334155; border-radius: 6px; border: 1px solid #475569;">
                            <div id="devSourcesUsed" style="font-size: 1.5rem; font-weight: bold; color: #3b82f6;">-</div>
                            <div style="font-size: 0.8rem; color: #94a3b8;">Sources utilis√©es</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: #334155; border-radius: 6px; border: 1px solid #475569;">
                            <div id="devHealthyCount" style="font-size: 1.5rem; font-weight: bold; color: #3b82f6;">-</div>
                            <div style="font-size: 0.8rem; color: #94a3b8;">Agents sains</div>
                        </div>
                    </div>
                </div>
                
                <div style="background: #0f172a; border-radius: 8px; padding: 1.5rem; border: 1px solid #334155;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h4 style="color: #f1f5f9;">Response</h4>
                        <div id="devStatusBadge" style="display: none; padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.8rem; font-weight: 600;"></div>
                    </div>
                    <div id="devResponseBody" style="background: #020617; border-radius: 6px; padding: 1rem; font-family: Monaco, monospace; font-size: 0.85rem; line-height: 1.4; color: #94a3b8; overflow-x: auto; border: 1px solid #1e293b; min-height: 200px;">
                        Aucune requ√™te effectu√©e. Utilisez les boutons ci-dessus pour tester l'API Discovery.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration pour l'API backend
        const API_BASE = '/api';
        
        // State management
        let agents = [];
        let editingAgent = null; // ‚úÖ Ajout√© pour tracker l'√©dition
        
        // Utility functions d'abord
        function showAlert(type, message) {
            const existingAlert = document.querySelector('.alert-floating');
            if (existingAlert) existingAlert.remove();
            
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-floating`;
            alert.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 1000;
                min-width: 300px;
                animation: slideIn 0.3s ease;
            `;
            alert.innerHTML = message.replace(/\n/g, '<br>');
            
            document.body.appendChild(alert);
            
            setTimeout(() => {
                alert.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => alert.remove(), 300);
            }, 3000);
        }

        // API Functions
        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                if (!response.ok) {
                    const error = await response.json().catch(() => ({ error: 'Network error' }));
                    throw new Error(error.error || `HTTP ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        async function loadAgents() {
            try {
                agents = await apiCall('/agents');
                renderAgentsList();
                updateStats();
            } catch (error) {
                showAlert('error', `‚ùå Failed to load agents: ${error.message}`);
                agents = [];
            }
        }

        async function saveAgent(agentData) {
            try {
                await apiCall('/agents', {
                    method: 'POST',
                    body: JSON.stringify(agentData)
                });
                await loadAgents(); // Reload from server
                showAlert('success', `‚úÖ Agent ${agentData.agent_uri} added successfully!`);
            } catch (error) {
                showAlert('error', `‚ùå Failed to add agent: ${error.message}`);
                throw error;
            }
        }

        async function updateAgent(originalUri, agentData) {
            try {
                await apiCall(`/agents/${encodeURIComponent(originalUri)}`, {
                    method: 'PUT',
                    body: JSON.stringify(agentData)
                });
                await loadAgents(); // Reload from server
                showAlert('success', `‚úÖ Agent ${agentData.agent_uri} updated successfully!`);
            } catch (error) {
                showAlert('error', `‚ùå Failed to update agent: ${error.message}`);
                throw error;
            }
        }
        async function deleteAgentFromServer(uri) {
            try {
                await apiCall(`/agents/${encodeURIComponent(uri)}`, {
                    method: 'DELETE'
                });
                await loadAgents(); // Reload from server
                showAlert('success', `‚úÖ Agent ${uri} deleted`);
            } catch (error) {
                showAlert('error', `‚ùå Failed to delete agent: ${error.message}`);
                throw error;
            }
        }

        async function resolveAgent(uri) {
            try {
                return await apiCall(`/resolve/${encodeURIComponent(uri)}`);
            } catch (error) {
                throw error;
            }
        }

        // Simple URI validation function
        function validateAgentURI(uri) {
            return /^agent:\/\/[a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?)*$/.test(uri);
        }
        
        // Tab functionality
        window.showTab = function(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        };
        
        // Discovery level info display
        document.getElementById('discoveryLevel').addEventListener('change', function() {
            const level = this.value;
            const infoDiv = document.getElementById('discoveryInfo');
            const infoDivs = ['publicInfo', 'internalInfo', 'privateInfo'];
            
            // Hide all info divs
            infoDivs.forEach(id => {
                document.getElementById(id).style.display = 'none';
            });
            
            // Show and style the appropriate info
            infoDiv.className = `discovery-info ${level}`;
            infoDiv.style.display = 'block';
            document.getElementById(`${level}Info`).style.display = 'block';
            
            // Update help text
            const helpText = {
                'public': 'This agent will be publicly discoverable via .well-known/agent.json',
                'internal': 'This agent will only be discoverable within your organization',
                'private': 'This agent will require manual configuration - no automatic discovery'
            };
            
            document.getElementById('discoveryHelp').textContent = helpText[level] || '';
        });
        
        // Trigger initial display
        document.getElementById('discoveryLevel').dispatchEvent(new Event('change'));
        
        // Agent management functionality
        document.getElementById('addAgentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            await addAgent();
        });
        
        async function addAgent() {
            const uri = document.getElementById('agentUri').value.trim();
            const endpoint = document.getElementById('endpoint').value.trim();
            const discoveryLevel = document.getElementById('discoveryLevel').value;
            const status = document.getElementById('status').value;
            const capabilities = document.getElementById('capabilities').value
                .split(',').map(c => c.trim()).filter(c => c);
            const description = document.getElementById('description').value.trim();
            
            if (!validateAgentURI(uri)) {
                showAlert('error', '‚ùå Invalid agent URI format');
                return;
            }
            
            const agentConfig = {
                agent_uri: uri,
                endpoint: endpoint,
                status: status,
                capabilities: capabilities,
                version: '1.0.0',
                metadata: {
                    description: description,
                    discovery_level: discoveryLevel
                }
            };
            
            try {
                if (editingAgent) {
                    // Update existing agent
                    await updateAgent(editingAgent, agentConfig);
                } else {
                    // Create new agent
                    await saveAgent(agentConfig);
                }
                clearForm();
                editingAgent = null; // Reset editing state
            } catch (error) {
                // Error already shown by saveAgent/updateAgent
            }
        }
        
        function updateStats() {
            const publicAgents = agents.filter(a => a.metadata?.discovery_level === 'public');
            const internalAgents = agents.filter(a => a.metadata?.discovery_level === 'internal');
            const privateAgents = agents.filter(a => a.metadata?.discovery_level === 'private');
            
            document.getElementById('publicCount').textContent = publicAgents.length;
            document.getElementById('internalCount').textContent = internalAgents.length;
            document.getElementById('privateCount').textContent = privateAgents.length;
            document.getElementById('totalCount').textContent = agents.length;
        }
        
        window.clearForm = function() {
            document.getElementById('addAgentForm').reset();
            document.getElementById('discoveryLevel').dispatchEvent(new Event('change'));
            
            // Reset editing state
            editingAgent = null;
            const submitBtn = document.querySelector('#addAgentForm button[type="submit"]');
            submitBtn.innerHTML = '‚ûï Add Agent';
        };
        
        function renderAgentsList() {
            const container = document.getElementById('agentsList');
            
            if (agents.length === 0) {
                container.innerHTML = '<p style="color: #6b7280; text-align: center; margin: 2rem 0;">No agents configured yet. Add your first agent above!</p>';
                return;
            }
            
            // Group agents by discovery level
            const publicAgents = agents.filter(agent => agent.metadata?.discovery_level === 'public');
            const internalAgents = agents.filter(agent => agent.metadata?.discovery_level === 'internal');
            const privateAgents = agents.filter(agent => agent.metadata?.discovery_level === 'private');
            
            let html = '';
            
            // Public agents section
            if (publicAgents.length > 0) {
                html += `
                    <div class="agent-section public">
                        <h4>üåê Public Agents (${publicAgents.length}) - Included in .well-known</h4>
                        ${renderAgentItems(publicAgents)}
                    </div>
                `;
            }
            
            // Internal agents section
            if (internalAgents.length > 0) {
                html += `
                    <div class="agent-section internal">
                        <h4>üè¢ Internal Agents (${internalAgents.length}) - Organization only</h4>
                        ${renderAgentItems(internalAgents)}
                    </div>
                `;
            }
            
            // Private agents section
            if (privateAgents.length > 0) {
                html += `
                    <div class="agent-section private">
                        <h4>üîí Private Agents (${privateAgents.length}) - Manual configuration only</h4>
                        ${renderAgentItems(privateAgents)}
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        function renderAgentItems(agentArray) {
            return agentArray.map(agent => `
                <div class="agent-item">
                    <div class="agent-info">
                        <h5>${agent.agent_uri} <span class="discovery-badge ${agent.metadata?.discovery_level || 'private'}">${agent.metadata?.discovery_level || 'private'}</span></h5>
                        <p><span class="status-indicator status-${agent.status}"></span>${agent.endpoint}</p>
                        <div class="capabilities">
                            ${(agent.capabilities || []).map(cap => `<span class="capability">${cap}</span>`).join('')}
                        </div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <button class="btn btn-secondary" onclick="editAgent('${agent.agent_uri}')">‚úèÔ∏è Edit</button>
                        <button class="btn btn-danger" onclick="deleteAgent('${agent.agent_uri}')">‚ùå Delete</button>
                    </div>
                </div>
            `).join('');
        }
        
        window.editAgent = function(uri) {
            const agent = agents.find(a => a.agent_uri === uri);
            if (!agent) return;
            
            // Set editing state
            editingAgent = uri;
            
            document.getElementById('agentUri').value = agent.agent_uri;
            document.getElementById('endpoint').value = agent.endpoint;
            document.getElementById('discoveryLevel').value = agent.metadata?.discovery_level || 'private';
            document.getElementById('status').value = agent.status;
            document.getElementById('capabilities').value = (agent.capabilities || []).join(', ');
            document.getElementById('description').value = agent.metadata?.description || '';
            
            // Trigger discovery level change
            document.getElementById('discoveryLevel').dispatchEvent(new Event('change'));
            
            // Change button text to indicate editing
            const submitBtn = document.querySelector('#addAgentForm button[type="submit"]');
            submitBtn.innerHTML = '‚úèÔ∏è Update Agent';
        };
        
        window.deleteAgent = async function(uri) {
            if (confirm(`Delete agent ${uri}?`)) {
                try {
                    await deleteAgentFromServer(uri);
                } catch (error) {
                    // Error already shown by deleteAgentFromServer
                }
            }
        };
        
        // Well-Known functionality
        window.generateWellKnown = function() {
            const domain = document.getElementById('domain').value;
            
            if (!domain) {
                showAlert('error', '‚ùå Please enter your domain first');
                return;
            }
            
            const publicAgents = agents.filter(agent => agent.metadata?.discovery_level === 'public');
            
            if (publicAgents.length === 0) {
                showAlert('error', '‚ùå No public agents configured. Add public agents first.');
                return;
            }
            
            const wellKnown = {
                owner: domain,
                agents: publicAgents.map(agent => ({
                    agent_uri: agent.agent_uri,
                    endpoint: agent.endpoint,
                    capabilities: agent.capabilities || [],
                    status: agent.status,
                    public: true,
                    metadata: {
                        description: agent.metadata?.description || "Generated via ANS Registry Admin",
                        contact: `support@${domain}`
                    }
                })),
                discovery_info: {
                    total_agents: agents.length,
                    public_agents: publicAgents.length,
                    internal_agents: agents.filter(a => a.metadata?.discovery_level === 'internal').length,
                    private_agents: agents.filter(a => a.metadata?.discovery_level === 'private').length,
                    contact: `admin@${domain}`
                },
                metadata: {
                    published_by: domain,
                    format_version: "0.1.0",
                    last_updated: new Date().toISOString()
                }
            };
            
            document.getElementById('wellKnownCode').textContent = JSON.stringify(wellKnown, null, 2);
            document.getElementById('wellKnownPreview').style.display = 'block';
            
            // Store for download
            window.currentWellKnown = wellKnown;
            
            showAlert('success', `‚úÖ Generated .well-known with ${publicAgents.length} public agents!`);
        };
        
        window.validateWellKnown = function() {
            const domain = document.getElementById('domain').value;
            if (!domain) {
                showAlert('error', '‚ùå Please enter your domain first');
                return;
            }
            
            let url;
            if (domain.startsWith('http://') || domain.startsWith('https://')) {
                const cleanDomain = domain.endsWith('/') ? domain.slice(0, -1) : domain;
                url = `${cleanDomain}/.well-known/agent.json`;
            } else {
                url = `https://${domain}/.well-known/agent.json`;
            }
            
            window.open(url, '_blank');
        };
        
        window.downloadWellKnown = function() {
            if (!window.currentWellKnown) {
                showAlert('error', '‚ùå Please generate the .well-known file first');
                return;
            }
            
            const blob = new Blob([JSON.stringify(window.currentWellKnown, null, 2)], 
                { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'agent.json';
            a.click();
            URL.revokeObjectURL(url);
            
            showAlert('success', 'üíæ File downloaded! Place it in your .well-known/ directory');
        };
        
        // Registry functionality
        window.testConnection = function() {
            const apiKey = document.getElementById('apiKey').value;
            const orgId = document.getElementById('organizationId').value;
            
            if (!apiKey || !orgId) {
                showAlert('error', '‚ùå Please enter API key and organization ID');
                return;
            }
            
            // Simulate connection test
            setTimeout(() => {
                document.getElementById('connectionStatus').className = 'alert alert-success';
                document.getElementById('statusText').textContent = 'Connected successfully';
                showAlert('success', '‚úÖ Connection test successful!');
            }, 1000);
        };
        
        window.syncAgents = function() {
            const agentCount = agents.length;
            setTimeout(() => {
                showAlert('success', `üîÑ Successfully synced ${agentCount} agents with ANS Registry!`);
            }, 1500);
        };
        
        // Testing functionality
        window.testAgentResolution = async function() {
            const uri = document.getElementById('testUri').value.trim();
            if (!uri) {
                showAlert('error', '‚ùå Please enter an agent URI to test');
                return;
            }
            
            const loading = document.getElementById('testLoading');
            const results = document.getElementById('testResults');
            
            loading.style.display = 'block';
            results.innerHTML = '';
            
            try {
                const result = await resolveAgent(uri);
                loading.style.display = 'none';
                
                if (result.error) {
                    results.innerHTML = `
                        <div class="test-result error">
                            <h4>‚ùå Resolution Failed</h4>
                            <p><strong>Error:</strong> ${result.message}</p>
                            <details style="margin-top: 1rem;">
                                <summary>üìã Full Response</summary>
                                <pre style="margin-top: 0.5rem; font-size: 0.8rem;">${JSON.stringify(result, null, 2)}</pre>
                            </details>
                        </div>
                    `;
                } else {
                    results.innerHTML = `
                        <div class="test-result">
                            <h4>‚úÖ Agent Found</h4>
                            <p><strong>Endpoint:</strong> <code>${result.endpoint}</code></p>
                            <p><strong>Status:</strong> <span style="color: #10b981;">${result.status}</span></p>
                            ${result.capabilities ? `<p><strong>Capabilities:</strong> ${result.capabilities.join(', ')}</p>` : ''}
                            ${result.metadata?.description ? `<p><strong>Description:</strong> ${result.metadata.description}</p>` : ''}
                            <details style="margin-top: 1rem;">
                                <summary>üìã Full Response</summary>
                                <pre style="margin-top: 0.5rem; font-size: 0.8rem;">${JSON.stringify(result, null, 2)}</pre>
                            </details>
                        </div>
                    `;
                }
            } catch (error) {
                loading.style.display = 'none';
                results.innerHTML = `
                    <div class="test-result error">
                        <h4>‚ùå Test Failed</h4>
                        <p><strong>Error:</strong> ${error.message}</p>
                    </div>
                `;
            }
        };
        
        window.validateUri = function() {
            const uri = document.getElementById('testUri').value.trim();
            if (!uri) {
                showAlert('error', '‚ùå Please enter an agent URI');
                return;
            }
            
            const isValid = validateAgentURI(uri);
            if (isValid) {
                showAlert('success', '‚úÖ Valid URI format');
            } else {
                showAlert('error', '‚ùå Invalid agent URI format');
            }
        };
        
        window.setTestUri = function(uri) {
            document.getElementById('testUri').value = uri;
        };
        
        // ========================
        // Discovery API Test Functions (Developer Interface)
        // ========================
        
        window.quickGatewayTest = function(scenario) {
            switch (scenario) {
                case 'billing':
                    document.getElementById('devCapabilities').value = 'billing,payment';
                    document.getElementById('devMinHealthScore').value = '80';
                    document.getElementById('devLimit').value = '3';
                    break;
                case 'support':
                    document.getElementById('devCapabilities').value = 'support,customer-service';
                    document.getElementById('devMinHealthScore').value = '70';
                    document.getElementById('devLimit').value = '5';
                    break;
                case 'healthy':
                    document.getElementById('devCapabilities').value = '';
                    document.getElementById('devMinHealthScore').value = '85';
                    // Select only healthy
                    const healthSelect = document.getElementById('devHealthStatus');
                    Array.from(healthSelect.options).forEach(opt => opt.selected = opt.value === 'healthy');
                    break;
                case 'fallback':
                    document.getElementById('devCapabilities').value = 'billing';
                    document.getElementById('devMinHealthScore').value = '60'; // Lower threshold for fallback
                    document.getElementById('devLimit').value = '10'; // More options for fallback
                    break;
            }
            testDiscoveryAPI();
        };
        
        async function testDiscoveryAPI() {
            const query = buildDevQuery();
            showDevLoading();
            
            try {
                const result = await apiCall('/discover', {
                    method: 'POST',
                    body: JSON.stringify(query)
                });
                displayDevResponse(result, 200);
            } catch (error) {
                displayDevResponse({
                    error: error.message,
                    timestamp: new Date().toISOString()
                }, 500);
            }
        }
        
        async function testSearchAPI() {
            const searchQuery = document.getElementById('devSearchQuery').value.trim();
            if (!searchQuery) {
                showAlert('error', '‚ùå Entrez un terme de recherche');
                return;
            }
            
            showDevLoading();
            
            try {
                const result = await apiCall(`/search/${encodeURIComponent(searchQuery)}`);
                displayDevResponse(result, 200);
            } catch (error) {
                displayDevResponse({
                    error: error.message,
                    timestamp: new Date().toISOString()
                }, 500);
            }
        }
        
        async function testHealthyAPI() {
            showDevLoading();
            
            try {
                const result = await apiCall('/healthy');
                displayDevResponse(result, 200);
            } catch (error) {
                displayDevResponse({
                    error: error.message,
                    timestamp: new Date().toISOString()
                }, 500);
            }
        }
        
        async function testCapabilitiesAPI() {
            const capabilities = document.getElementById('devCapabilitiesQuery').value.trim();
            if (!capabilities) {
                showAlert('error', '‚ùå Entrez des capabilities');
                return;
            }
            
            showDevLoading();
            
            try {
                const result = await apiCall(`/capabilities/${encodeURIComponent(capabilities)}`);
                displayDevResponse(result, 200);
            } catch (error) {
                displayDevResponse({
                    error: error.message,
                    timestamp: new Date().toISOString()
                }, 500);
            }
        }
        
        function buildDevQuery() {
            const capabilitiesText = document.getElementById('devCapabilities').value.trim();
            const capabilities = capabilitiesText ? capabilitiesText.split(',').map(c => c.trim()).filter(c => c) : [];
            
            const statusElements = document.getElementById('devStatus').selectedOptions;
            const status = Array.from(statusElements).map(opt => opt.value);
            
            const healthElements = document.getElementById('devHealthStatus').selectedOptions;
            const health_status = Array.from(healthElements).map(opt => opt.value);
            
            const levelElements = document.getElementById('devDiscoveryLevel').selectedOptions;
            const discovery_level = Array.from(levelElements).map(opt => opt.value);
            
            return {
                capabilities: capabilities.length > 0 ? capabilities : undefined,
                organization: document.getElementById('devOrganization').value.trim() || undefined,
                status: status.length > 0 ? status : undefined,
                discovery_level: discovery_level.length > 0 ? discovery_level : undefined,
                health_status: health_status.length > 0 ? health_status : undefined,
                limit: parseInt(document.getElementById('devLimit').value) || 10,
                min_health_score: parseInt(document.getElementById('devMinHealthScore').value) || 0,
                include_local: document.getElementById('devIncludeLocal').checked,
                include_wellknown: document.getElementById('devIncludeWellKnown').checked,
                include_global: document.getElementById('devIncludeGlobal').checked
            };
        }
        
        function showDevLoading() {
            document.getElementById('devResponseBody').innerHTML = '<div style="text-align: center; color: #3b82f6; padding: 2rem;">üîÑ Requ√™te en cours...</div>';
            document.getElementById('devResponseMetrics').style.display = 'none';
            document.getElementById('devStatusBadge').style.display = 'none';
        }
        
        function displayDevResponse(data, status) {
            // Update metrics if available
            if (data.agents) {
                document.getElementById('devAgentsFound').textContent = data.agents.length;
                document.getElementById('devHealthyCount').textContent = 
                    data.agents.filter(a => a.health?.status === 'healthy' || a.status === 'active').length;
                document.getElementById('devSourcesUsed').textContent = data.sources?.length || 1;
            } else {
                document.getElementById('devAgentsFound').textContent = '0';
                document.getElementById('devHealthyCount').textContent = '0';
                document.getElementById('devSourcesUsed').textContent = '1';
            }
            
            document.getElementById('devQueryTime').textContent = `${data.query_time_ms || 0}ms`;
            document.getElementById('devResponseMetrics').style.display = 'grid';
            
            // Update status badge
            const badge = document.getElementById('devStatusBadge');
            badge.style.display = 'block';
            if (status === 200) {
                badge.className = 'status-badge';
                badge.style.background = '#065f46';
                badge.style.color = '#a7f3d0';
                badge.textContent = '200 OK';
            } else {
                badge.className = 'status-badge';
                badge.style.background = '#991b1b';
                badge.style.color = '#fca5a5';
                badge.textContent = `${status} Error`;
            }
            
            // Format and display JSON response
            document.getElementById('devResponseBody').innerHTML = formatDevJSON(data);
        }
        
        function formatDevJSON(obj) {
            const jsonString = JSON.stringify(obj, null, 2);
            return jsonString
                .replace(/"([^"]+)":/g, '<span style="color: #60a5fa;">"$1"</span>:')
                .replace(/: "([^"]+)"/g, ': <span style="color: #34d399;">"$1"</span>')
                .replace(/: (\d+)/g, ': <span style="color: #fbbf24;">$1</span>')
                .replace(/: (true|false)/g, ': <span style="color: #f472b6;">$1</span>');
        }
        
        window.generateDiscoveryCurl = function() {
            const query = buildDevQuery();
            const curl = `curl -X POST http://localhost:3000/api/discover \\
  -H "Content-Type: application/json" \\
  -d '${JSON.stringify(query, null, 2)}'`;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(curl);
                showAlert('success', 'üìã cURL copi√© dans le presse-papier !');
            } else {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = curl;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showAlert('success', 'üìã cURL copi√© !');
            }
        };
        
        window.clearDevForm = function() {
            document.getElementById('devCapabilities').value = '';
            document.getElementById('devOrganization').value = '';
            document.getElementById('devSearchQuery').value = '';
            document.getElementById('devCapabilitiesQuery').value = '';
            document.getElementById('devMinHealthScore').value = '0';
            document.getElementById('devLimit').value = '10';
            
            // Reset multiselects to default
            const statusSelect = document.getElementById('devStatus');
            Array.from(statusSelect.options).forEach(opt => opt.selected = opt.value === 'active');
            
            const healthSelect = document.getElementById('devHealthStatus');
            Array.from(healthSelect.options).forEach(opt => opt.selected = opt.value === 'healthy');
            
            const levelSelect = document.getElementById('devDiscoveryLevel');
            Array.from(levelSelect.options).forEach(opt => opt.selected = true);
            
            // Reset checkboxes
            document.getElementById('devIncludeLocal').checked = true;
            document.getElementById('devIncludeWellKnown').checked = true;
            document.getElementById('devIncludeGlobal').checked = false;
            
            // Clear response
            document.getElementById('devResponseBody').innerHTML = 'Aucune requ√™te effectu√©e. Utilisez les boutons ci-dessus pour tester l\'API Discovery.';
            document.getElementById('devResponseMetrics').style.display = 'none';
            document.getElementById('devStatusBadge').style.display = 'none';
        };
        
        // Add hover effects for quick test cards
        document.addEventListener('DOMContentLoaded', function() {
            const quickTestCards = document.querySelectorAll('.quick-test-card');
            quickTestCards.forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.style.borderColor = '#3b82f6';
                    this.style.background = '#475569';
                });
                card.addEventListener('mouseleave', function() {
                    this.style.borderColor = '#475569';
                    this.style.background = '#334155';
                });
            });
        });
        
        // Health monitoring functions
        window.runHealthCheck = async function() {
            try {
                showAlert('info', 'üîÑ Running health checks...');
                const agents = await apiCall('/agents');
                if (agents.length === 0) {
                    showAlert('error', '‚ùå No agents to check');
                    return;
                }
                
                const results = await apiCall('/health/check', {
                    method: 'POST',
                    body: JSON.stringify({ agents })
                });
                
                const healthyCount = results.filter(r => r.health?.status === 'healthy').length;
                const degradedCount = results.filter(r => r.health?.status === 'degraded').length;
                const unhealthyCount = results.filter(r => r.health?.status === 'unhealthy').length;
                
                const resultsHtml = `
                    <div class="stats-bar">
                        <div class="stat-item">
                            <div class="stat-number" style="color: #10b981;">${healthyCount}</div>
                            <div class="stat-label">üíö Healthy</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" style="color: #f59e0b;">${degradedCount}</div>
                            <div class="stat-label">üü° Degraded</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" style="color: #ef4444;">${unhealthyCount}</div>
                            <div class="stat-label">‚ùå Unhealthy</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">${results.length}</div>
                            <div class="stat-label">üìä Total</div>
                        </div>
                    </div>
                    <div style="margin-top: 1rem;">
                        ${results.map(agent => `
                            <div class="agent-item">
                                <div class="agent-info">
                                    <h5>${agent.agent_uri}</h5>
                                    <p>${agent.endpoint}</p>
                                    ${agent.health ? `
                                        <div style="font-size: 0.9rem; margin-top: 0.5rem;">
                                            Status: <strong>${agent.health.status}</strong> (${agent.health.score}/100)<br>
                                            Response: ${agent.health.response_time_ms || 0}ms ‚Ä¢ 
                                            Errors: ${agent.health.error_count} ‚Ä¢ 
                                            Uptime: ${agent.health.uptime_percentage}%
                                        </div>
                                    ` : ''}
                                </div>
                                <div style="text-align: center;">
                                    ${agent.health?.status === 'healthy' ? 'üíö' : agent.health?.status === 'degraded' ? 'üü°' : '‚ùå'}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                document.getElementById('healthResults').innerHTML = resultsHtml;
                showAlert('success', `‚úÖ Health check completed: ${healthyCount} healthy, ${degradedCount} degraded, ${unhealthyCount} unhealthy`);
            } catch (error) {
                showAlert('error', `‚ùå Health check failed: ${error.message}`);
            }
        };
        
        window.getHealthStats = async function() {
            try {
                const stats = await apiCall('/health/stats');
                const statsHtml = `
                    <div class="stats-bar">
                        <div class="stat-item">
                            <div class="stat-number">${stats.total_checks_performed}</div>
                            <div class="stat-label">üîç Total Checks</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">${stats.healthy_agents}</div>
                            <div class="stat-label">üíö Healthy</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">${stats.degraded_agents}</div>
                            <div class="stat-label">üü° Degraded</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">${stats.unhealthy_agents}</div>
                            <div class="stat-label">‚ùå Unhealthy</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">${stats.average_response_time}ms</div>
                            <div class="stat-label">‚è±Ô∏è Avg Response</div>
                        </div>
                    </div>
                    <div class="alert alert-info" style="margin-top: 1rem;">
                        <strong>Cache Stats:</strong><br>
                        üìã Cached agents: ${stats.cache_stats.cached_agents}<br>
                        üéØ Hit rate: ${Math.round(stats.cache_stats.cache_hit_rate * 100)}%<br>
                        ‚è∞ Oldest entry: ${Math.round(stats.cache_stats.oldest_entry_age / 1000)}s ago
                    </div>
                `;
                document.getElementById('healthResults').innerHTML = statsHtml;
            } catch (error) {
                showAlert('error', `‚ùå Failed to get health stats: ${error.message}`);
            }
        };
        
        window.clearHealthCache = async function() {
            try {
                await apiCall('/health/cache', { method: 'DELETE' });
                showAlert('success', '‚úÖ Health cache cleared');
            } catch (error) {
                showAlert('info', 'üí° Health cache clearing not implemented in API yet');
            }
        };
        
        // Initialize - Load agents from server
        loadAgents();
        
        console.log('ü§ñ ANS Registry Admin loaded with JSON persistence and Agent Discovery');
        console.log('üîç Agent Discovery features:');
        console.log('  ‚Ä¢ Multi-source discovery (local, well-known, global)');
        console.log('  ‚Ä¢ Advanced filtering (capabilities, status, health)');
        console.log('  ‚Ä¢ Text search across agents');
        console.log('  ‚Ä¢ Health monitoring and statistics');
        console.log('  ‚Ä¢ Real-time agent validation');
    </script>
</body>
</html>